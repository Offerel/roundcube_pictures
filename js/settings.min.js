function checkToken(){let e=document.getElementById("pixelfed_token"),t=document.getElementById("pixelfed_instance"),s=t.value.endsWith("/")?t.value.substr(0,t.value.length-1):t.value;xhr=new XMLHttpRequest,xhr.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let t=JSON.parse(this.responseText);void 0!==t.acct?(rcmail.display_message("Authentication for "+t.acct+" successful","confirmation"),e.classList.add("success"),e.classList.remove("error")):(rcmail.display_message("Authentication failed","error"),e.classList.remove("success"),e.classList.add("error"))}else rcmail.display_message("Pixelfed Server error, please check instance","error"),e.classList.remove("success"),e.classList.add("error")},xhr.open("GET",s+"/api/v1/accounts/verify_credentials"),xhr.setRequestHeader("Authorization","Bearer "+e.value),xhr.send()}function checkInstance(){let e=document.getElementById("pixelfed_instance"),t=document.getElementById("aplink"),s=e.value.endsWith("/")?e.value.substr(0,e.value.length-1):e.value;xhr=new XMLHttpRequest,xhr.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let a=JSON.parse(this.responseText);if(void 0!==a.version){let n=a.version.split("; ")[1];n=n.substr(0,n.length-1).split(" ")[1],rcmail.display_message("Pixelfed instance with "+n+" found","confirmation"),t.classList.remove("disabled"),e.classList.add("success"),e.classList.remove("error"),t.href=s+"/settings/applications";a.configuration.statuses.max_characters,a.configuration.statuses.characters_reserved_per_url;document.getElementById("pixelfed_max_media").value=a.configuration.statuses.max_media_attachments}else rcmail.display_message("Invalid Pixelfed URL, version check failed","error"),e.classList.add("error"),e.classList.remove("success"),t.classList.add("disabled")}},xhr.open("GET",s+"/api/v2/instance"),xhr.send()}window.rcmail&&rcmail.addEventListener("init",function(e){if(document.getElementById("pixelfed_instance")){let e=document.getElementById("pixelfed_instance");e.addEventListener("change",checkInstance),document.getElementById("pixelfed_token").addEventListener("change",checkToken);let t=document.getElementById("pixelfed_token").parentElement.parentElement,s=document.createElement("tr"),a=document.createElement("td");a.colSpan=2,a.classList.add("tdhint");let n=rcmail.gettext("pfapphint","pictures"),i=e.value;i=i.endsWith("/")?i.substr(0,i.length-1):i,i+="/settings/applications",a.innerHTML=n.replace("%link%","<a href='"+i+"' target='_blank' id='aplink' class='disabled'>Applications</a>"),s.appendChild(a),t.parentNode.insertBefore(s,t),0!=e.value.length&&document.getElementById("aplink").classList.remove("disabled")}});