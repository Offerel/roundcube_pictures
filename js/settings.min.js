function registerApp(e){function t(e,t,n){let s=new FormData;s.append("client_name","Roundcube Photos"),s.append("redirect_uris",e),s.append("scopes",t),s.append("website","https://codeberg.org/Offerel/Roundcube_Pictures");let a=sendRequest(n,s,"/api/v1/apps");return a}function n(e,t,n,s,a){let r=new FormData;return r.append("client_id",e),r.append("client_secret",t),r.append("redirect_uri",n),r.append("grant_type","client_credentials"),r.append("scope",s),result=sendRequest(a,r,"/oauth/token"),result}function s(e,t){return result=sendRequest(t,null,"/api/v1/apps/verify_credentials","GET",e),result}function a(){const e=new URLSearchParams({client_id:i,scope:d,redirect_uri:p,response_type:"code"}),t=JSON.stringify({client_id:i,client_secret:l,redirect_uri:p,instance:c.value,token:r,scope:d});document.cookie="appval="+(t||"")+"; max-age=1800; secure; path=/";let n=700,s=580,a=window.screen.availLeft+(window.screen.availWidth/2-n/2),o=window.screen.availHeight/2-s/2;window.open(c.value+"/oauth/authorize?"+e.toString(),"popup","width="+n+",height="+s+",left="+a+",top="+o/2+",menubar=no,status=no")}e.preventDefault(),e.stopPropagation();let r,i,l,c=document.getElementById("pixelfed_instance"),o=c.value,d="read write",p=location.protocol+"//"+location.host+location.pathname+"?_task=pictures";c.value=o.endsWith("/")?o.substr(0,o.length-1):o;let u=t(p,d,c.value);if(200!==u.status)return rcmail.display_message(rcmail.gettext("app_reg_failed","pictures").replace("%instance%",c.value),"error"),!1;i=u.response.client_id,l=u.response.client_secret;let m=n(i,l,p,d,c.value);if(200!==m.status)return rcmail.display_message(rcmail.gettext("app_token_failed","pictures"),"error"),!1;r=m.response.access_token;let f=s(r,c.value);if(200!==f.status)return rcmail.display_message(rcmail.gettext("app_verify_failed","pictures"),"error"),!1;a()}function ProcessChildMessage(e){document.getElementById("pixelfed_token").value=e}function sendRequest(e,t,n,s="POST",a){let r={},i=new XMLHttpRequest;return i.onload=function(){r.status=i.status,200===i.status&&(r.response=JSON.parse(this.response))},i.open(s,e+n,!1),void 0!==a&&i.setRequestHeader("Authorization","Bearer "+a),i.send(t),r}window.rcmail&&rcmail.addEventListener("init",function(e){if(document.getElementById("pixelfed_instance")){let e=document.getElementById("pixelfed_instance");e.addEventListener("change",t=>{let n=e.value.endsWith("/")?e.value.substr(0,e.value.length-1):e.value,s=sendRequest(n,null,"/api/v2/instance","GET");if(200==s.status)if(void 0!==s.response.version){let t,n=s.response.title;switch(n){case"Pixelfed":t=s.response.version.split("; ")[1],t=substr(0,t.length-1);break;case"Mastodon":t=s.response.version;break;default:return!1}rcmail.display_message(n+" instance with "+t+" found","confirmation"),e.classList.add("success"),e.classList.remove("error"),document.getElementById("pft").value=n,document.getElementById("pfm").value=s.response.configuration.statuses.max_media_attachments,document.getElementById("pfc").value=s.response.configuration.statuses.max_characters}else rcmail.display_message("Invalid URL, check failed","error"),e.classList.add("error"),e.classList.remove("success");e.value=n});let t=document.createElement("tr"),n=document.createElement("td");n.colSpan=2,n.classList.add("tdhint");let s=document.createElement("a");s.id="pf_auth_link",s.innerText="Register App",s.href="#",s.addEventListener("click",registerApp),n.appendChild(s),t.appendChild(n);let a=document.getElementById("pft").parentElement.parentElement;a.parentNode.insertBefore(t,a)}});