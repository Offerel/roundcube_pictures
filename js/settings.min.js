function sendRequest(e,t,s,a="POST",n){let i={},r=new XMLHttpRequest;return r.onload=function(){i.status=r.status,200===r.status&&(i.response=JSON.parse(this.response))},r.open(a,e+s,!1),void 0!==n&&r.setRequestHeader("Authorization","Bearer "+n),r.send(t),i}function checkToken(){let e=document.getElementById("pixelfed_token"),t=document.getElementById("pixelfed_instance"),s=t.value.endsWith("/")?t.value.substr(0,t.value.length-1):t.value;xhr=new XMLHttpRequest,xhr.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let t=JSON.parse(this.responseText);void 0!==t.acct?(rcmail.display_message("Authentication for "+t.acct+" successful","confirmation"),e.classList.add("success"),e.classList.remove("error")):(rcmail.display_message("Authentication failed","error"),e.classList.remove("success"),e.classList.add("error"))}else rcmail.display_message("Pixelfed Server error, please check instance","error"),e.classList.remove("success"),e.classList.add("error")},xhr.open("GET",s+"/api/v1/accounts/verify_credentials"),xhr.setRequestHeader("Authorization","Bearer "+e.value),xhr.send()}function checkInstance(){let e=document.getElementById("pixelfed_instance"),t=document.getElementById("aplink"),s=e.value.endsWith("/")?e.value.substr(0,e.value.length-1):e.value;xhr=new XMLHttpRequest,xhr.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let a=JSON.parse(this.responseText);if(void 0!==a.version){let n="";switch(a.title){case"Pixelfed":n=a.version.split("; ")[1];break;case"Mastodon":n=a.version;break;default:return!1}rcmail.display_message(a.title+" instance with "+n+" found","confirmation"),t.classList.remove("disabled"),e.classList.add("success"),e.classList.remove("error"),t.href=s+"/settings/applications"}else rcmail.display_message("Invalid Pixelfed URL, version check failed","error"),e.classList.add("error"),e.classList.remove("success"),t.classList.add("disabled")}},xhr.open("GET",s+"/api/v2/instance"),xhr.send()}window.rcmail&&rcmail.addEventListener("init",function(e){if(document.getElementById("pixelfed_instance")){let e=document.getElementById("pixelfed_instance");e.addEventListener("change",checkInstance),document.getElementById("pixelfed_token").addEventListener("change",checkToken);let t=document.getElementById("pixelfed_token").parentElement.parentElement,s=document.createElement("tr"),a=document.createElement("td");a.colSpan=2,a.classList.add("tdhint");let n=rcmail.gettext("pfapphint","pictures"),i=e.value,r=i.endsWith("/")?i.substr(0,i.length-1):i;i=r+"/settings/applications",a.innerHTML=n.replace("%link%","<a href='"+i+"' target='_blank' id='aplink' class='disabled'>Applications</a>");let l=document.createElement("a");l.id="pf_auth_link",l.innerText="Register App",l.href="#",l.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();let t=location.protocol+"//"+location.host+location.pathname+"?_task=pictures",s="read write",a=new FormData;a.append("client_name","Roundcube Photos"),a.append("redirect_uris",t),a.append("scopes",s),a.append("website","https://codeberg.org/Offerel/Roundcube_Pictures");let n=sendRequest(r,a,"/api/v1/apps");if(200===n.status){let e=n.response.client_id,a=n.response.client_secret,i=new FormData;if(i.append("client_id",e),i.append("client_secret",a),i.append("redirect_uri",t),i.append("grant_type","client_credentials"),i.append("scope",s),n=sendRequest(r,i,"/oauth/token"),200===n.status){let i=n.response.access_token;if(n=sendRequest(r,null,"/api/v1/apps/verify_credentials","GET",i),200===n.status){new URLSearchParams({client_id:e,scope:s,redirect_uri:t,response_type:"code"});let n=new FormData;n.append("id",e),n.append("se",a),n.append("ru",t),n.append("tk",i),n.append("bu",r),sendRequest(t,n,""),setTimeout(function(){const e=document.cookie.split(";");for(let t of e){let[e,s]=t.trim().split("=");if("pfmdrt"===e){res=1===s?"Success":"failed",document.getElementById("test").innerText=res;break}}},3e3)}else rcmail.display_message(rcmail.gettext("app_verify_failed","pictures"),"error")}else rcmail.display_message(rcmail.gettext("app_token_failed","pictures"),"error")}else rcmail.display_message(rcmail.gettext("app_reg_failed","pictures").replace("%instance%",r),"error")});let c=document.createElement("a");c.id="test",c.innerText="Untestet",c.href="#",a.appendChild(l),a.appendChild(c),s.appendChild(a),t.parentNode.insertBefore(s,t),0!=e.value.length&&document.getElementById("aplink").classList.remove("disabled")}});