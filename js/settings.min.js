function registerApp(e){function t(e,t,s){let n=new FormData;n.append("client_name","Roundcube Photos"),n.append("redirect_uris",e),n.append("scopes",t),n.append("website","https://codeberg.org/Offerel/Roundcube_Pictures");let a=sendRequest(s,n,"/api/v1/apps");return a}function s(e,t,s,n,a){let i=new FormData;return i.append("client_id",e),i.append("client_secret",t),i.append("redirect_uri",s),i.append("grant_type","client_credentials"),i.append("scope",n),result=sendRequest(a,i,"/oauth/token"),result}function n(e,t){return result=sendRequest(t,null,"/api/v1/apps/verify_credentials","GET",e),result}function a(){const e=new URLSearchParams({client_id:r,scope:o,redirect_uri:p,response_type:"code"}),t=JSON.stringify({client_id:r,client_secret:c,redirect_uri:p,instance:l.value,token:i,scope:o});document.cookie="appval="+(t||"")+"; max-age=1800; secure; path=/";let s=700,n=400,a=window.screen.availLeft+(window.screen.availWidth/2-s/2),d=window.screen.availHeight/2-n/2;window.open(l.value+"/oauth/authorize?"+e.toString(),"popup","width="+s+",height="+n+",left="+a+",top="+d/2+",menubar=no,status=no")}e.preventDefault(),e.stopPropagation();let i,r,c,l=document.getElementById("pixelfed_instance"),d=l.value,o="read write",p=location.protocol+"//"+location.host+location.pathname+"?_task=pictures";l.value=d.endsWith("/")?d.substr(0,d.length-1):d;let u=t(p,o,l.value);if(200!==u.status)return rcmail.display_message(rcmail.gettext("app_reg_failed","pictures").replace("%instance%",l.value),"error"),!1;r=u.response.client_id,c=u.response.client_secret;let m=s(r,c,p,o,l.value);if(200!==m.status)return rcmail.display_message(rcmail.gettext("app_token_failed","pictures"),"error"),!1;i=m.response.access_token;let h=n(i,l.value);if(200!==h.status)return rcmail.display_message(rcmail.gettext("app_verify_failed","pictures"),"error"),!1;a()}function sendRequest(e,t,s,n="POST",a){let i={},r=new XMLHttpRequest;return r.onload=function(){i.status=r.status,200===r.status&&(i.response=JSON.parse(this.response))},r.open(n,e+s,!1),void 0!==a&&r.setRequestHeader("Authorization","Bearer "+a),r.send(t),i}function checkToken(){let e=document.getElementById("pixelfed_token"),t=document.getElementById("pixelfed_instance"),s=t.value.endsWith("/")?t.value.substr(0,t.value.length-1):t.value;xhr=new XMLHttpRequest,xhr.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let t=JSON.parse(this.responseText);void 0!==t.acct?(rcmail.display_message("Authentication for "+t.acct+" successful","confirmation"),e.classList.add("success"),e.classList.remove("error")):(rcmail.display_message("Authentication failed","error"),e.classList.remove("success"),e.classList.add("error"))}else rcmail.display_message("Pixelfed Server error, please check instance","error"),e.classList.remove("success"),e.classList.add("error")},xhr.open("GET",s+"/api/v1/accounts/verify_credentials"),xhr.setRequestHeader("Authorization","Bearer "+e.value),xhr.send()}function checkInstance(){let e=document.getElementById("pixelfed_instance"),t=document.getElementById("aplink"),s=e.value.endsWith("/")?e.value.substr(0,e.value.length-1):e.value;xhr=new XMLHttpRequest,xhr.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let n=JSON.parse(this.responseText);if(void 0!==n.version){let a="";switch(n.title){case"Pixelfed":a=n.version.split("; ")[1];break;case"Mastodon":a=n.version;break;default:return!1}rcmail.display_message(n.title+" instance with "+a+" found","confirmation"),t.classList.remove("disabled"),e.classList.add("success"),e.classList.remove("error"),t.href=s+"/settings/applications"}else rcmail.display_message("Invalid Pixelfed URL, version check failed","error"),e.classList.add("error"),e.classList.remove("success"),t.classList.add("disabled")}},xhr.open("GET",s+"/api/v2/instance"),xhr.send()}window.rcmail&&rcmail.addEventListener("init",function(e){if(document.getElementById("pixelfed_instance")){let e=document.getElementById("pixelfed_instance");e.addEventListener("change",checkInstance),document.getElementById("pixelfed_token").addEventListener("change",checkToken);let t=document.getElementById("pixelfed_token").parentElement.parentElement,s=document.createElement("tr"),n=document.createElement("td");n.colSpan=2,n.classList.add("tdhint");rcmail.gettext("pfapphint","pictures");let a=e.value,i=a.endsWith("/")?a.substr(0,a.length-1):a;a=i+"/settings/applications";let r=document.createElement("a");r.id="pf_auth_link",r.innerText="Register App",r.href="#",r.addEventListener("click",registerApp),n.appendChild(r),s.appendChild(n),t.parentNode.insertBefore(s,t)}});