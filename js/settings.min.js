function sendRequest(e,t,s){xhr=new XMLHttpRequest,xhr.onload=function(){let e={};return 200===xhr.status&&(e.response=this.response),e.status=xhr.status,e},xhr.open("POST",e+s),xhr.responseType="json",xhr.send(t)}function checkToken(){let e=document.getElementById("pixelfed_token"),t=document.getElementById("pixelfed_instance"),s=t.value.endsWith("/")?t.value.substr(0,t.value.length-1):t.value;xhr=new XMLHttpRequest,xhr.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let t=JSON.parse(this.responseText);void 0!==t.acct?(rcmail.display_message("Authentication for "+t.acct+" successful","confirmation"),e.classList.add("success"),e.classList.remove("error")):(rcmail.display_message("Authentication failed","error"),e.classList.remove("success"),e.classList.add("error"))}else rcmail.display_message("Pixelfed Server error, please check instance","error"),e.classList.remove("success"),e.classList.add("error")},xhr.open("GET",s+"/api/v1/accounts/verify_credentials"),xhr.setRequestHeader("Authorization","Bearer "+e.value),xhr.send()}function checkInstance(){let e=document.getElementById("pixelfed_instance"),t=document.getElementById("aplink"),s=e.value.endsWith("/")?e.value.substr(0,e.value.length-1):e.value;xhr=new XMLHttpRequest,xhr.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let n=JSON.parse(this.responseText);if(void 0!==n.version){let a=n.version.split("; ")[1];a=a.substr(0,a.length-1).split(" ")[1],rcmail.display_message("Pixelfed instance with "+a+" found","confirmation"),t.classList.remove("disabled"),e.classList.add("success"),e.classList.remove("error"),t.href=s+"/settings/applications";n.configuration.statuses.max_characters,n.configuration.statuses.characters_reserved_per_url;document.getElementById("pixelfed_max_media").value=n.configuration.statuses.max_media_attachments}else rcmail.display_message("Invalid Pixelfed URL, version check failed","error"),e.classList.add("error"),e.classList.remove("success"),t.classList.add("disabled")}},xhr.open("GET",s+"/api/v2/instance"),xhr.send()}window.rcmail&&rcmail.addEventListener("init",function(e){if(document.getElementById("pixelfed_instance")){let e=document.getElementById("pixelfed_instance");e.addEventListener("change",checkInstance),document.getElementById("pixelfed_token").addEventListener("change",checkToken);let t=document.getElementById("pixelfed_token").parentElement.parentElement,s=document.createElement("tr"),n=document.createElement("td");n.colSpan=2,n.classList.add("tdhint");let a=rcmail.gettext("pfapphint","pictures"),i=e.value,r=i.endsWith("/")?i.substr(0,i.length-1):i;i=r+"/settings/applications",n.innerHTML=a.replace("%link%","<a href='"+i+"' target='_blank' id='aplink' class='disabled'>Applications</a>");let l=document.createElement("input");l.id="pf_cid",l.type="hidden";let c=document.createElement("input");c.id="pf_sec",c.type="hidden";let d=document.createElement("a");d.id="pf_auth_link",d.innerText="Register App",d.href="#",d.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();let t=new FormData;t.append("client_name","Pictures"),t.append("redirect_uris",location.protocol+"//"+location.host+location.pathname+"?_task=pictures, urn:ietf:wg:oauth:2.0:oob"),t.append("scopes","read write"),t.append("website","https://codeberg.org/Offerel/Roundcube_Pictures");let s=sendRequest(r,t,"/api/v1/apps");console.log(s),200===s?(l.value=s.response.client_id,c.value=s.response.client_secret):rcmail.display_message("App registration failed","error")}),n.appendChild(d),n.appendChild(l),n.appendChild(c),s.appendChild(n),t.parentNode.insertBefore(s,t),0!=e.value.length&&document.getElementById("aplink").classList.remove("disabled")}});