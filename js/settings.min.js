function registerApp(e){function t(e,t,n){let s=new FormData;s.append("client_name","Roundcube Photos"),s.append("redirect_uris",e),s.append("scopes",t),s.append("website","https://codeberg.org/Offerel/Roundcube_Pictures");let a=sendRequest(n,s,"/api/v1/apps");return a}function n(e,t,n,s,a){let i=new FormData;return i.append("client_id",e),i.append("client_secret",t),i.append("redirect_uri",n),i.append("grant_type","client_credentials"),i.append("scope",s),result=sendRequest(a,i,"/oauth/token"),result}function s(e,t){return result=sendRequest(t,null,"/api/v1/apps/verify_credentials","GET",e),result}function a(){const e=new URLSearchParams({client_id:r,scope:u,redirect_uri:d,response_type:"code"}),t=JSON.stringify({client_id:r,client_secret:l,redirect_uri:d,instance:c.value,token:i,scope:u});localStorage.setItem("appval",t);let n=700,s=580,a=window.screen.availLeft+(window.screen.availWidth/2-n/2),o=window.screen.availHeight/2-s/2;window.open(c.value+"/oauth/authorize?"+e.toString(),"popup","width="+n+",height="+s+",left="+a+",top="+o/2+",menubar=no,status=no")}e.preventDefault(),e.stopPropagation();let i,r,l,c=document.getElementById("pixelfed_instance"),o=c.value,u="read write",d=location.protocol+"//"+location.host+location.pathname+"?_task=pictures";c.value=o.endsWith("/")?o.substr(0,o.length-1):o;let p=t(d,u,c.value);if(200!==p.status)return rcmail.display_message(rcmail.gettext("app_reg_failed","pictures").replace("%instance%",c.value),"error"),!1;r=p.response.client_id,l=p.response.client_secret;let m=n(r,l,d,u,c.value);if(200!==m.status)return rcmail.display_message(rcmail.gettext("app_token_failed","pictures"),"error"),!1;i=m.response.access_token;let f=s(i,c.value);if(200!==f.status)return rcmail.display_message(rcmail.gettext("app_verify_failed","pictures"),"error"),!1;a()}function ProcessChildMessage(e){document.getElementById("pixelfed_token").value=e,setTimeout(()=>{document.getElementById("rcmbtnfrm100").click()},10)}function sendRequest(e,t,n,s="POST",a){let i={},r=new XMLHttpRequest;return r.onload=function(){i.status=r.status,200===r.status&&(i.response=JSON.parse(this.response))},r.open(s,e+n,!1),void 0!==a&&r.setRequestHeader("Authorization","Bearer "+a),r.send(t),i}window.rcmail&&rcmail.addEventListener("init",function(e){if(document.getElementById("pixelfed_instance")){let e=document.getElementById("pixelfed_instance");e.addEventListener("change",t=>{let n=e.value.endsWith("/")?e.value.substr(0,e.value.length-1):e.value,s=sendRequest(n,null,"/api/v2/instance","GET");if(200==s.status)if(void 0!==s.response.version){let t,n=s.response.title;switch(n){case"Pixelfed":t=s.response.version.split("; ")[1],t=substr(0,t.length-1);break;case"Mastodon":t=s.response.version;break;default:return!1}rcmail.display_message(n+" instance with "+t+" found","confirmation"),e.classList.add("success"),e.classList.remove("error"),document.getElementById("pft").value=n,document.getElementById("pfm").value=s.response.configuration.statuses.max_media_attachments,document.getElementById("pfc").value=s.response.configuration.statuses.max_characters}else rcmail.display_message("Invalid URL, check failed","error"),e.classList.add("error"),e.classList.remove("success");e.value=n});let t=document.createElement("a");t.id="pf_auth_link",t.innerText="Register App",t.href="#",t.addEventListener("click",registerApp),document.getElementById("pft").parentElement.appendChild(t)}});