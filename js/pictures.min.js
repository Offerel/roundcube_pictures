function checkUser(e){$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{img_action:"cUser",images:[],user:e},success:function(e){let t=document.getElementById("sname"),n=document.getElementById("shares"),d=document.getElementById("rsh"),l=document.getElementById("expiredate"),o=document.getElementById("never");1==e?(console.log("internal share to"),t.disabled=!0,n.disabled=!0,d.disabled=!0,l.disabled=!0,l.style.color="lightgray",o.disabled=!0):(console.log("external share"),t.disabled=!1,n.disabled=!1,d.disabled=!1,l.disabled=!1,l.style.color="black",o.disabled=!1)}})}function iBoxShow(e){let t=document.getElementById("infbtn").dataset.iid,n=document.getElementById(t);"click"==e.type?(clicks+=1,clicks%2!=0?(n.classList.add("eshow"),this.removeEventListener("mouseover",iBoxShow,!0),this.removeEventListener("mouseout",iBoxShow,!0)):(this.addEventListener("mouseover",iBoxShow,!0),this.addEventListener("mouseout",iBoxShow,!0))):n.classList.toggle("eshow")}function dosearch(){let e=document.getElementById("skeywords").value.split(" ").filter(e=>e);if(e.length<=0)return document.getElementById("searchphotof").style.display="none",!1;$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{alb_action:"search",target:"",src:"",keyw:JSON.stringify(e)},success:function(t){document.getElementById("searchphotof").style.display="none",setTimeout(()=>{if(t.length>30){let n=document.getElementById("picturescontentframe");if(n.contentWindow.document.getElementById("images").innerHTML=t,n.contentWindow.document.getElementById("folders")){let e=n.contentWindow.document.getElementById("folders");e.innerHTML="",e.style.display="none"}let d=n.contentWindow.document.querySelector("#header .breadcrumb");d.innerHTML="<li>"+rcmail.gettext("searchfor","pictures")+e.join(", ")+"</li>",n.contentWindow.$("#images").justifiedGallery({rowHeight:220,margins:7,border:0,lastRow:"nojustify",captions:!0,randomize:!1,selector:".glightbox"}),n.contentWindow.$("#images").justifiedGallery("norewind"),n.contentWindow.lightbox.reload()}else alert(rcmail.gettext("noresults","pictures"))},50)}})}function searchform(){$("#searchphotof").contents().find("h2").html(rcmail.gettext("search","pictures")),document.getElementById("searchphotof").style.display="block",document.getElementById("skeywords").focus()}function metaform(){let e=document.getElementById("picturescontentframe"),t=e.contentWindow.document.querySelectorAll('input[type="checkbox"]:checked'),n=[];for(let e=0;e<t.length;e++){let d=new URLSearchParams(new URL(t[e].baseURI).search).get("p");n.push(d+"/"+t[e].value)}$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{alb_action:"gmdata",target:"",src:"",files:JSON.stringify(n)},success:function(e){let t=JSON.parse(e);2==t.keywords?(document.getElementById("mekeywords").placeholder="Multiple Values",document.getElementById("mekeywords").value=""):document.getElementById("mekeywords").value=t.keywords,2==t.title?(document.getElementById("metitle").placeholder="Multiple Values",document.getElementById("metitle").value=""):document.getElementById("metitle").value=t.title,2==t.description?(document.getElementById("medescription").placeholder="Multiple Values",document.getElementById("medescription").value=""):document.getElementById("medescription").value=t.description}}),$("#metadata").contents().find("h2").html(rcmail.gettext("metadata","pictures")),document.getElementById("metadata").style.display="block",document.getElementById("mekeywords").focus()}function save_meta(e){const t=document.getElementById("picturescontentframe"),n=t.contentWindow.document.querySelectorAll('input[type="checkbox"]:checked');dloader("#metadata",mes,"add");let d=[];for(let e=0;e<n.length;e++){let t=new URLSearchParams(new URL(n[e].baseURI).search).get("p");d.push(t+"/"+n[e].value)}const l={keywords:JSON.parse(document.getElementById("mekeywords").value).map(e=>e.value),title:document.getElementById("metitle").value,description:document.getElementById("medescription").value,files:d};let o=l.keywords.filter(t=>!e.includes(t));$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{alb_action:"keywords",target:"",src:"",keywords:JSON.stringify(o)},success:function(e){tagify.whitelist=JSON.parse(e)}}),$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{alb_action:"mfiles",target:"",src:"",data:JSON.stringify(l)},success:function(e){0!=e?rcmail.display_message(e,"error"):rcmail.display_message("Data saved","confirmation"),dloader("#metadata",mes,"remove"),document.getElementById("metadata").style.display="none"}})}function count_checks(){document.querySelectorAll('input[type="checkbox"]:checked').length>0?(window.parent.document.getElementById("movepicture").classList.remove("disabled"),window.parent.document.getElementById("delpicture").classList.remove("disabled"),window.parent.document.getElementById("sharepicture").classList.remove("disabled"),window.parent.document.getElementById("editmeta").classList.remove("disabled")):(window.parent.document.getElementById("movepicture").classList.add("disabled"),window.parent.document.getElementById("delpicture").classList.add("disabled"),window.parent.document.getElementById("sharepicture").classList.add("disabled"),window.parent.document.getElementById("editmeta").classList.add("disabled"))}function lazyload(e=!1){$.ajax({type:"POST",url:window.location.href,async:!1,data:{s:$(".glightbox").length},success:function(e){$("#images").append(e),$("#images").justifiedGallery("norewind");const t=(new DOMParser).parseFromString(e,"text/html");return t.body.childNodes.forEach(e=>{e.classList&&e.classList.contains("glightbox")&&lightbox.insertSlide({href:e.href,type:e.dataset.type})}),lightbox.reload(),e}})}function uploadpicture(){let e=document.createElement("input");const t=decodeURI(new URL(document.getElementById("picturescontentframe").contentWindow.document.getElementById("header").lastElementChild.href).search.substring(3));e.type="file",e.multiple="multiple",e.accept="image/webp, image/jpeg, image/png",e.id="ufrm",e.addEventListener("change",function(){document.getElementById("picturescontentframe").contentWindow.document.getElementById("loader").style.visibility="visible",xhr=new XMLHttpRequest;let n=new FormData;const d=e.files;for(let e=0;e<d.length;e++){const t=d[e];n.append("galleryfiles[]",t,t.name)}n.append("folder",t),xhr.onload=function(){200===xhr.status&&(document.getElementById("picturescontentframe").contentWindow.location.href="plugins/pictures/photos.php?p="+encodeURIComponent(t))},xhr.open("POST","./plugins/pictures/photos.php"),xhr.send(n)});let n=document.getElementById("picturescontentframe").contentWindow.document.body;n.appendChild(e),e.click()}function selectShare(){getshares(),document.getElementById("sid").value="",document.getElementById("sname").value="",document.getElementById("expiredate").value="",document.getElementById("expiredate").disabled=!1,document.getElementById("rsh").disabled=!0,document.getElementById("never").checked=!1,document.getElementById("link").value="",document.getElementById("link").style.visibility="hidden",document.getElementById("sbtn").style.visibility="visible",$("#share_edit").contents().find("h2").html(rcmail.gettext("share","pictures")),document.getElementById("share_edit").style.display="block";let e=new Date;document.getElementById("expiredate").valueAsDate=new Date(e.setDate(e.getDate()+30))}function add_album(){var e=get_currentalbum();$("#album_edit").contents().find("h2").html(rcmail.gettext("new_album","pictures")),$("#album_org").val(e),$("#album_name").val(""),document.getElementById("mv_target").style.display="none",document.getElementById("albedit").style.display="none",document.getElementById("albadd").style.display="block",document.getElementById("album_edit").style.display="block",document.getElementById("album_name").focus()}function create_album(){var e=document.getElementById("album_org").value,t=document.getElementById("album_name").value;$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{alb_action:"create",target:t,src:e},success:function(t){1==t&&(document.getElementById("album_edit").style.display="none")?(document.getElementById("picturescontentframe").contentWindow.location.href="plugins/pictures/photos.php?p="+encodeURIComponent(e),getsubs()):alert(t)}})}function get_currentalbum(){var e=window.frames.picturescontentframe.location.search.substring(1).replace(/\+/g,"%20");if(""==e)return!1;for(e=e.split("#")[0],e=e.split("&");0<e.length;)return e=e[0].split("="),"p"==e[0]&&e[1]}function edit_album(){album=decodeURIComponent(get_currentalbum());var e=album.split("/");$("#album_edit").contents().find("h2").html("Album: "+e[e.length-1]),$("#album_name").val(e[e.length-1]),$("#album_org").val(album),-1!==document.getElementById("mv_target").innerHTML.indexOf("div")&&getsubs(),document.getElementById("albedit").style.display="block",document.getElementById("albadd").style.display="none",document.getElementById("mv_target").style.display="block",document.getElementById("album_edit").style.display="block",document.getElementById("album_name").focus()}function getsubs(){$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{getsubs:"1"},success:function(e){$("#mv_target").html(e),setTimeout(document.getElementById("target").addEventListener("change",mvbtncl),1e3)}})}function mvbtncl(){document.getElementById("mvb").classList.remove("disabled"),document.getElementById("album_name").value=document.getElementById("album_org").value.split("/").pop(),document.getElementById("rnb").classList.add("disabled")}function getshares(){$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{getshares:"1"},success:function(e){$("#share_target").html(e),document.getElementById("shares").addEventListener("change",function(e){if(document.getElementById("sname").value=e.target.selectedOptions[0].text,document.getElementById("sid").value=parseInt(e.target.selectedOptions[0].value)?e.target.selectedOptions[0].value:"",document.getElementById("link").value="",document.getElementById("rsh").disabled=!parseInt(e.target.selectedOptions[0].value),null==e.target.selectedOptions[0].dataset.ep||e.target.selectedOptions[0].dataset.ep){document.getElementById("never").checked=!1,document.getElementById("expiredate").disabled=!1;let t=new Date;document.getElementById("expiredate").valueAsDate=null==e.target.selectedOptions[0].dataset.ep?new Date(t.setDate(t.getDate()+30)):new Date(1e3*e.target.selectedOptions[0].dataset.ep)}else document.getElementById("never").checked=!0,document.getElementById("expiredate").value="",document.getElementById("expiredate").disabled=!0})}})}function rename_album(){var e=document.getElementById("album_org").value,t=document.getElementById("album_name").value;$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{alb_action:"rename",target:t,src:e},success:function(t){1==t&&(document.getElementById("album_edit").style.display="none",document.getElementById("picturescontentframe").contentWindow.location.href="plugins/pictures/photos.php?p="+encodeURIComponent(e),getsubs())}})}function move_album(){var e=document.getElementById("album_org").value,t=document.getElementById("target").value;$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{alb_action:"move",target:t,src:e},success:function(e){1==e&&(document.getElementById("album_edit").style.display="none",document.getElementById("picturescontentframe").contentWindow.location.href="plugins/pictures/photos.php?p="+encodeURIComponent(t),getsubs())}})}function delete_album(){var e=document.getElementById("album_org").value;if(confirm(rcmail.gettext("galdconfirm","pictures"))){let t=document.getElementById("dalb");dloader("#album_edit",t,"add"),$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{alb_action:"delete",src:e},success:function(e){dloader("#album_edit",t,"remove"),1==e&&(document.getElementById("album_edit").style.display="none",document.getElementById("picturescontentframe").contentWindow.location.href="plugins/pictures/photos.php",getsubs())}})}}function sharepicture(){var e=[];let t=document.getElementById("sbtn");dloader("#share_edit",t,"add");let n=document.getElementById("link");n.style.visibility="hidden",$("#picturescontentframe").contents().find(":checkbox:checked").each(function(){const t=new URL($(this)[0].previousElementSibling.firstChild.src).searchParams;e.push(t.get("file"))}),$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{img_action:"share",images:e,shareid:document.getElementById("sid").value,sharename:document.getElementById("sname").value,expiredate:Math.floor(document.getElementById("expiredate").valueAsNumber/1e3)},success:function(e){const d=new URL(location.href);let l=d.protocol+"//"+d.hostname+d.pathname+"?_task=pictures&slink="+e;$("#link").contents().get(0).nodeValue=l;let o=document.getElementById("btnclp");o.addEventListener("click",e=>(e.preventDefault(),copyPageUrl(l),document.getElementById("share_edit").style.display="none",window.parent.document.getElementById("info").style.display="none",!1)),o.style.visibility="visible",n.style.visibility="visible",dloader("#share_edit",t,"remove"),t.style.visibility="hidden"}})}async function copyPageUrl(e){try{await navigator.clipboard.writeText(e)}catch(e){console.error("Failed to copy: ",e)}}function dloader(e,t,n){document.getElementById("mdark")&&document.getElementById("mdark").remove();let d=document.querySelector(e+" .modal-content"),l=document.createElement("div");l.id="mdark","add"==n?(d.appendChild(l),t.classList.add("loading")):t.classList.remove("loading")}function copyLink(){let e=document.getElementById("link").innerText;return navigator.clipboard.writeText(e),document.getElementById("share_edit").style.display="none",window.parent.document.getElementById("info").style.display="none",!1}function move_picture(){let e=document.getElementById("mvp");dloader("#img_edit",e,"add");var t=[],n=document.getElementById("album_org_img").value,d=document.getElementById("album_name_img").value,l=document.getElementById("target").selectedOptions[0].value;$("#picturescontentframe").contents().find(":checkbox:checked").each(function(){t.push($(this).val())}),$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{img_action:"move",images:t,orgPath:n,target:l,newPath:d},success:function(t){1==t&&(document.getElementById("img_edit").style.display="none",document.getElementById("picturescontentframe").contentWindow.location.reload(!0)),dloader("#img_edit",e,"remove")}})}function mv_img(){var e=window.frames.picturescontentframe.location.search.slice(1),t="";if(e){for(e=e.split("#")[0],e=e.split("&"),t=0;t<e.length;t++){var n=e[t].split("=");if("p"==n[0])break}t=n[1]}t=decodeURI(t),$("#img_edit").contents().find("h2").html(rcmail.gettext("move_image","pictures")),$("#album_name_img").attr("placeholder",rcmail.gettext("new_album","pictures")),document.getElementById("album_name_img").addEventListener("input",function(){document.getElementById("rpath").innerText=document.getElementById("target").selectedOptions[0].value+"/"+document.getElementById("album_name_img").value}),$("#album_org_img").val(t),-1!==document.getElementById("mv_target_img").innerHTML.indexOf("div")&&$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{getsubs:"1"},success:function(e){$("#mv_target_img").html(e),document.getElementById("target").addEventListener("change",function(){document.getElementById("mvp").classList.remove("disabled"),document.getElementById("rpath").innerText=document.getElementById("target").selectedOptions[0].value+"/"+document.getElementById("album_name_img").value})}}),document.getElementById("rpath").innerHTML="&nbsp;",document.getElementById("target")&&(document.getElementById("target").selectedIndex=0),document.getElementById("album_name_img").value="",document.getElementById("img_edit").style.display="block"}function delete_picture(){var e=[],t=window.frames.picturescontentframe.location.search.slice(1),n="";if(t){for(t=t.split("#")[0],t=t.split("&"),n=0;n<t.length;n++){var d=t[n].split("=");if("p"==d[0])break}n=d[1]}n=decodeURI(n),$("#picturescontentframe").contents().find(":checkbox:checked").each(function(){e.push($(this).val())});let l=rcmail.gettext("picdconfirm","pictures").replace("%c",e.length);if(!confirm(l))return!1;$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{img_action:"delete",images:e,orgPath:n},success:function(e){1==e&&document.getElementById("picturescontentframe").contentWindow.location.reload(!0)}})}var lightbox,tagify,clicks;window.rcmail&&rcmail.addEventListener("init",function(e){rcmail.register_command("rename_alb",rename_album,!0),rcmail.register_command("move_alb",move_album,!0),rcmail.register_command("sharepicture",selectShare,!0),rcmail.register_command("uploadpicture",uploadpicture,!0),rcmail.register_command("sharepic",sharepicture,!0),rcmail.register_command("delete_alb",delete_album,!0),rcmail.register_command("addalbum",add_album,!0),rcmail.register_command("add_alb",create_album,!0),rcmail.register_command("movepicture",mv_img,!0),rcmail.register_command("move_image",move_picture,!0),rcmail.register_command("delpicture",delete_picture,!0),rcmail.register_command("searchphoto",searchform,!0),rcmail.register_command("edit_meta",metaform,!0)}),window.onload=function(){if($("#images").length){$("#images").justifiedGallery({rowHeight:220,margins:7,border:0,lastRow:"nojustify",captions:!1,randomize:!1,selector:".glightbox"}),$("#images").justifiedGallery().on("jg.complete",function(e){e.currentTarget.clientHeight>100&&e.currentTarget.clientHeight<document.documentElement.clientWidth&&lazyload()});let n=new IntersectionObserver(function(e){let t=!document.getElementById("last");e[0].isIntersecting&&e[0].time>700&&t&&lazyload(!0)},{threshold:[0]});n.observe(document.querySelector("#btm")),lightbox=GLightbox({plyr:{config:{iconUrl:"plugins/pictures/js/plyr/plyr.svg",muted:!0}},autoplayVideos:!1,loop:!1,videosWidth:"100%",closeOnOutsideClick:!1}),lightbox.on("close",()=>{document.getElementById("infbtn")&&document.getElementById("infbtn").remove(),document.querySelectorAll(".exinfo").forEach(e=>{e.classList.remove("eshow")})}),lightbox.on("slide_changed",e=>{document.querySelectorAll(".exinfo").forEach(e=>{e.classList.remove("eshow")}),clicks=0,document.getElementById("infbtn")&&document.getElementById("infbtn").remove(),document.getElementById("fbtn")&&document.getElementById("fbtn").remove();let t=new URL(e.current.slideConfig.href),n="exif_"+t.searchParams.get("p"),d=document.querySelector(".gclose");if(document.getElementById("infbtn")&&document.getElementById("infbtn").remove(),document.getElementById(n)){document.getElementById("infbtn")&&document.getElementById("infbtn").remove();let e=document.createElement("button");e.id="infbtn",e.dataset.iid=n,e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" version="1.0" viewBox="0 0 160 160"><g fill="white"><path d="M80 15c-35.88 0-65 29.12-65 65s29.12 65 65 65 65-29.12 65-65-29.12-65-65-65zm0 10c30.36 0 55 24.64 55 55s-24.64 55-55 55-55-24.64-55-55 24.64-55 55-55z"/><path d="M89.998 51.25a11.25 11.25 0 1 1-22.5 0 11.25 11.25 0 1 1 22.5 0zm.667 59.71c-.069 2.73 1.211 3.5 4.327 3.82l5.008.1V120H60.927v-5.12l5.503-.1c3.291-.1 4.082-1.38 4.327-3.82V80.147c.035-4.879-6.296-4.113-10.757-3.968v-5.074L90.665 70"/></g></svg>',e.addEventListener("mouseover",iBoxShow,!0),e.addEventListener("mouseout",iBoxShow,!0),e.addEventListener("click",iBoxShow,!0),d.before(e)}}),lightbox.on("slide_before_change",e=>{let t=e.current.index+1,n=document.getElementsByClassName("glightbox").length,d=!document.getElementById("last");t==n&&d&&setTimeout(lazyload,100,!0)});var e=window.scrollY,t=document.getElementById("header");window.onscroll=function(){var n=window.scrollY;e>n?(t.style.top="0",n>150?t.classList.add("shadow"):t.classList.remove("shadow")):(t.style.top="-55px",t.classList.remove("shadow")),e=n}}if(top.location!=self.location&&(top.location=self.location.href),window.addEventListener("contextmenu",function(e){return e.preventDefault(),e.stopPropagation(),!1}),document.getElementById("never")&&document.getElementById("never").addEventListener("change",function(){if(1!=this.checked){document.getElementById("expiredate").disabled=!1;let e=new Date;document.getElementById("expiredate").valueAsDate=new Date(e.setDate(e.getDate()+30))}else document.getElementById("expiredate").disabled=!0,document.getElementById("expiredate").value=""}),document.getElementById("rsh")&&document.getElementById("rsh").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),$.ajax({type:"POST",url:"plugins/pictures/photos.php",data:{img_action:"dshare",share:document.getElementById("shares").selectedOptions[0].value},success:function(e){getshares(),document.getElementById("sid").value="",document.getElementById("sname").value="",document.getElementById("expiredate").value="",document.getElementById("expiredate").disabled=!1,document.getElementById("rsh").disabled=!0,document.getElementById("never").checked=!1,document.getElementById("link").value="";let t=new Date;return document.getElementById("expiredate").valueAsDate=new Date(t.setDate(t.getDate()+30)),!1}})}),document.getElementById("skeywords")&&document.getElementById("skeywords").addEventListener("input",function(e){document.getElementById("skeywords").value.length>0&&document.getElementById("spb").classList.remove("disabled")}),document.getElementById("spb")&&document.getElementById("spb").addEventListener("click",function(){dosearch()}),document.getElementById("csb")&&document.getElementById("csb").addEventListener("click",function(e){document.getElementById("searchphotof").style.display="none"}),document.getElementById("mec")&&document.getElementById("mec").addEventListener("click",function(){document.getElementById("metadata").style.display="none"}),document.getElementById("searchphotof")){document.querySelector("#searchphotof form").addEventListener("submit",function(e){e.preventDefault(),dosearch()}),document.getElementById("metitle").addEventListener("input",function(e){document.getElementById("metitle").value.length>0&&document.getElementById("mes").classList.remove("disabled")}),document.getElementById("medescription").addEventListener("input",function(e){document.getElementById("medescription").value.length>0&&document.getElementById("mes").classList.remove("disabled")});const e=null!=rcmail.env.ptags?JSON.parse(rcmail.env.ptags):[];tagify=new Tagify(document.getElementById("mekeywords"),{whitelist:e,dropdown:{classname:"color-blue",trim:!0,enabled:0,maxItems:e.length,position:"text",closeOnSelect:!1,highlightFirst:!0},trim:!0,duplicates:!1,enforceWhitelist:!1,delimiters:",|;"}),tagify.on("add remove",function(e){document.getElementById("mes").classList.remove("disabled")}),document.getElementById("mes")&&document.getElementById("mes").addEventListener("click",function(){save_meta(e)})}document.getElementById("suser").addEventListener("blur",function(e){checkUser(this.value)})};