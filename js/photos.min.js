function isTouchDevice(){try{return document.createEvent("TouchEvent"),!0}catch(e){return!1}}function initGallery(){let e=parseInt(document.getElementById("scount").dataset.margin);$("#folders").justifiedGallery({rowHeight:220,maxRowHeight:220,margins:e,border:0,lastRow:"nojustify",captions:!1,randomize:!1}),$(".fimages").justifiedGallery({rowHeight:190,maxRowHeight:220,margins:e,border:0,lastRow:"nojustify",captions:!0,randomize:!1})}function markDay(){for(let e of document.querySelectorAll(".marker, .dhfmt"))e.addEventListener("click",t=>{let n=e.parentNode.dataset.day;if(1==e.dataset.cb){for(let e of document.querySelectorAll('[data-dday="'+n+'"]'))e.checked=!1;e.dataset.cb=0,e.parentElement.firstElementChild.classList.remove("marked")}else{for(let e of document.querySelectorAll('[data-dday="'+n+'"]'))e.checked=!0;e.dataset.cb=1,e.parentElement.firstElementChild.classList.add("marked")}count_checks()})}function count_checks(){let e=document.querySelectorAll(".icheckbox:checked").length;e>0?(scount.innerText=scount.dataset.text.replace("%count%",e),scount.style.display="inline",window.parent.document.getElementById("movepicture").classList.remove("disabled"),window.parent.document.getElementById("delpicture").classList.remove("disabled"),window.parent.document.getElementById("sharepicture").classList.remove("disabled"),window.parent.document.getElementById("editmeta").classList.remove("disabled")):(scount.innerText="",scount.style.display="none",window.parent.document.getElementById("movepicture").classList.add("disabled"),window.parent.document.getElementById("delpicture").classList.add("disabled"),window.parent.document.getElementById("sharepicture").classList.add("disabled"),window.parent.document.getElementById("editmeta").classList.add("disabled"))}function checkboxes(){let e=$(".icheckbox"),t=null;e.click(function(n){if(t){if(n.shiftKey){let n=e.index(this),o=e.index(t);e.slice(Math.min(n,o),Math.max(n,o)+1).prop("checked",t.checked)}t=this}else t=this})}function iBoxShow(e){let t=document.getElementById(document.getElementById("infbtn").dataset.iid),n=t.cloneNode(!0);n.id="infobox",n.classList.add("eshow"),document.getElementById("infobox")?(document.getElementById("infobox").remove(),null==e&&document.querySelector(".gcontainer").append(n)):document.querySelector(".gcontainer").append(n)}function stop_loop(){if(document.getElementById("pbtn")){let e=document.getElementById("pbtn");e.classList.remove("on"),e.addEventListener("click",loop_slide.bind(this,5))}clearInterval(intervalID),document.getElementById("slide_progress").style.width=0}function loop_slide(e=3){function t(){n>=100?(clearInterval(intervalID),loop_slide(e)):(n+=100/(60*e),document.getElementById("slide_progress").style.width=n+"vw")}document.getElementById("pbtn").classList.add("on"),lightbox.nextSlide();var n=1;intervalID=setInterval(t,10)}function aLoader(e="visible"){document.getElementById("loader").style.visibility=e}function handleDragOver(e){e.preventDefault(),"body"!=this.localName&&this.classList.add("mmn-drop")}function handleDragLeave(e){e.preventDefault(),this.classList.remove("mmn-drop")}function handleDrop(e){e.stopPropagation(),e.preventDefault(),this.classList.remove("mmn-drop");let t=this.parentElement.href?this.parentElement.href:location.href,n=new URL(t).searchParams.get("p");startUpload(e.dataTransfer.files,n)}function startUpload(e,t){let n=new FormData;xhr=new XMLHttpRequest;let o=$maxfiles,l=["image/jpeg","video/mp4"];t=decodeURIComponent((t+"").replace(/\+/g,"%20"));let i=document.getElementById("progress");if(e.length>o)return console.log("You try to upload more than the max count of allowed files("+o+")"),!1;for(var d=0;d<e.length;d++){if(-1==l.indexOf(e.item(d).type))return console.log("Unsupported filetype("+e.item(d).name+"), exiting"),!1;n.append("galleryfiles[]",e.item(d),e.item(d).name),n.append("folder",t)}xhr.upload.addEventListener("progress",function(e){let t=Math.ceil(e.loaded/e.total*100);i.style.visibility="visible",i.firstChild.innerHTML=t+"%",i.firstChild.style.width=t+"%"}),xhr.onload=function(){if(200===xhr.status){let t=JSON.parse(xhr.responseText),n="";for(var e=0;e<t.length;e++){switch(t[e].type){case"error":n="#dc3545";break;case"warning":n="#ffc107";break;default:n="#28a745"}i.firstChild.style.backgroundColor=n,console.log(t[e].message)}setTimeout(function(){i.style.visibility="hidden",i.firstChild.style.width=0,i.firstChild.style.backgroundColor="#007bff",location.reload(),count_checks()},5e3)}},xhr.open("POST","photos.php"),xhr.send(n)}function lazyload(e=!1){if(document.getElementById("last")&&!e)return!1;if(document.getElementsByClassName("glightbox").length<=0&&!e)return!1;let t=$(document).height()-10,n=Math.ceil($(window).scrollTop()+$(window).height()),o=document.getElementById("timeline")?"timeline":scount.dataset.title;if(n>t||e){let e=document.querySelectorAll(".ddiv"),t="timeline"===o?parseInt(e[e.length-1].dataset.ts)+1:$(".glightbox").length,n=new Date(1e3*t);n.setHours(0),n.setMinutes(0),n.setSeconds(-1),$.ajax({type:"POST",url:"photos.php",async:!1,beforeSend:aLoader("visible"),data:JSON.stringify({action:"lazyload",g:o,s:t,t:Date.parse(n)/1e3}),contentType:"application/json; charset=utf-8",success:function(e){aLoader("hidden"),"timeline"==o?($("#timeline").append(e),initGallery(),markDay()):($(".fimages").append(e),$(".fimages").justifiedGallery("norewind"));const t=(new DOMParser).parseFromString(e,"text/html");return t.body.childNodes.forEach(e=>{if(e instanceof HTMLDivElement)if("timeline"===o){if(e.classList.contains("fimages"))for(let t of e.querySelectorAll(".image"))lightbox.insertSlide({href:t.firstChild.href,type:t.firstChild.dataset.type})}else lightbox.insertSlide({href:e.firstChild.href,type:e.firstChild.dataset.type})}),lightbox.reload(),!1}})}}var intervalID;window.onload=function(){let e=document.getElementById("scount"),t=e.dataset.prd,n=e.dataset.title.split("/"),o=n.length>0&&""!=n[0]?t+" - "+n[n.length-1]:t;window.parent.document.title=o,"complete"!==document.readyState&&aLoader("hidden"),initGallery(),$(".fimages").justifiedGallery().on("jg.complete",function(e){for(e of(e.currentTarget.clientHeight>100&&e.currentTarget.clientHeight<document.documentElement.clientWidth&&e.currentTarget.classList.contains("alb")&&lazyload(),document.getElementsByClassName("icheckbox")))e.addEventListener("change",count_checks)}),$(window).scroll(function(){lazyload()}),lightbox=GLightbox({plyr:{config:{muted:!0}},autoplayVideos:!1,loop:!1,videosWidth:"100%",closeOnOutsideClick:!1,closeButton:!0}),lightbox.on("slide_changed",e=>{let t=e.current.index+1,n=lightbox.elements.length,o=!!document.getElementById("pbtn")&&document.getElementById("pbtn").classList.contains("on"),l=new URL(e.current.slideConfig.href).searchParams.get("file").split("/").slice(-1)[0],i=document.createElement("button"),d=document.createElement("button");i.id="dlbtn",d.id="fbtn",i.addEventListener("click",t=>{window.location="simg.php?w=3&file="+new URL(e.current.slideConfig.href).searchParams.get("file").replace(/([^:])(\/\/+)/g,"$1/")}),d.addEventListener("click",e=>{document.fullscreenElement?document.exitFullscreen():document.getElementById("glightbox-body").requestFullscreen(),d.classList.toggle("on")});let a=document.querySelector(".gclose");document.getElementById("btn_container")&&document.getElementById("btn_container").remove();let s=document.createElement("div");s.id="btn_container";document.getElementById(l);let r=document.createElement("button");r.id="infbtn",document.getElementById(l)?(r.dataset.iid=l,r.addEventListener("click",iBoxShow,!0)):r.disabled=!0;let c=document.createElement("button");c.id="pbtn",o?(c.classList.add("on"),c.addEventListener("click",stop_loop)):c.addEventListener("click",loop_slide.bind(this,5));let m=document.createElement("button");m.id="sbtn",m.addEventListener("click",t=>{let n="simg.php"+new URL(e.current.slideConfig.href).search;document.querySelector('[href="'+n+'"]').parentElement.querySelector(".icheckbox").checked=!0,window.parent.selectShare()}),s.appendChild(c),s.appendChild(i),s.appendChild(m),s.appendChild(r),s.appendChild(d),s.appendChild(a);let u=document.querySelector(".gcontainer");u.appendChild(s),document.getElementById("infobox")&&iBoxShow(),document.getElementById("last")&&t===n&&stop_loop()}),lightbox.on("slide_before_change",e=>{let t=e.current.index+1,n=lightbox.elements.length,o=!document.getElementById("last");t==n&&o&&setTimeout(lazyload,100,!0)}),lightbox.on("close",()=>{stop_loop(),document.querySelectorAll(".exinfo").forEach(e=>{e.classList.remove("eshow")})}),lightbox.on("open",()=>{document.querySelector(".gclose").addEventListener("click",()=>{document.getElementById("infbtn")&&document.getElementById("infbtn").remove(),document.getElementById("dlbtn")&&document.getElementById("dlbtn").remove(),document.getElementById("fbtn")&&document.getElementById("fbtn").remove(),document.querySelectorAll(".exinfo").forEach(e=>{e.classList.remove("eshow")})},{once:!0})}),Array.from(document.getElementsByClassName("folder")).forEach(function(e,t,n){e.addEventListener("click",function(){aLoader()})}),checkboxes(),markDay();let l=window.scrollY,i=document.getElementById("header");if(i){let e=document.querySelector("#header .breadcrumb");e.lastElementChild.previousElementSibling.addEventListener("click",function(t){e.childElementCount>2&&(t.preventDefault(),window.parent.edit_album())}),document.getElementById("aadd").addEventListener("click",e=>{parent.add_album()}),window.onscroll=function(){var e=window.scrollY;l>e?(i.style.top="0",e>150?i.classList.add("shadow"):i.classList.remove("shadow")):(i.style.top="-55px",i.classList.remove("shadow")),l=e};let t=new URL(location.href).searchParams;if(t.has("p")){let e=t.get("p");e?localStorage.setItem("pnavp",e):localStorage.setItem("pnavp","start")}else{const e={p:localStorage.getItem("pnavp")};location.href="photos.php?"+new URLSearchParams(e).toString()}}e.addEventListener("click",e=>{parent.rm_checks()});for(var d=document.getElementsByClassName("dropzone"),a=0;a<d.length;a++)d[a].addEventListener("dragover",handleDragOver,!1),d[a].addEventListener("dragleave",handleDragLeave,!1),d[a].addEventListener("drop",handleDrop,!1);let s=document.getElementById("moveCal");const r=e=>{try{var t=isTouchDevice()?e.touches[0].clientY:e.clientY,n=isTouchDevice()?e.touches[0].clientX:e.clientX}catch(e){}s.style.top=t-2+"px",setTimeout(()=>{let e=document.elementFromPoint(n,t);e.classList.contains("myd")&&(s.innerText=e.dataset.range,s.dataset.ts=e.dataset.ts)},10)},c=e=>{let t=document.querySelectorAll(".icheckbox");const n=JSON.stringify({action:"timeline",data:{s:parseInt(t[t.length-1].dataset.os),t:document.getElementById("moveCal").dataset.ts}});xhr=new XMLHttpRequest,xhr.onload=function(){aLoader("hidden");let e=this.response;const t=(new DOMParser).parseFromString(e,"text/html");let n=t.querySelector(".ddiv").dataset.day,o=t.querySelector(".ddiv").dataset.ts,l=document.getElementsByClassName("ddiv"),i=new Array;for(let e=0;e<l.length;e++)i.push(l[e].dataset.ts);const d=e=>i.find(t=>t<e);let a=d(o);return void 0===a?$("#timeline").append(e):$('[data-ts="'+a+'"]').before(e),t.body.childNodes.forEach(e=>{if(e instanceof HTMLDivElement&&e.classList.contains("fimages"))for(let t of e.querySelectorAll(".image"))lightbox.insertSlide({href:t.firstChild.href,type:t.firstChild.dataset.type})}),initGallery(),markDay(),lightbox.reload(),document.querySelector("[data-day='"+n+"']").scrollIntoView({behavior:"smooth",block:"start",inline:"start"}),!1},xhr.open("POST","photos.php"),xhr.setRequestHeader("Content-type","application/json; charset=utf-8"),xhr.send(n)};document.getElementById("scroller")&&(document.getElementById("scroller").addEventListener("mousemove",r),document.getElementById("scroller").addEventListener("touchmove",r),document.getElementById("scroller").addEventListener("click",c))};